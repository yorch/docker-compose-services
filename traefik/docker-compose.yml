version: "3.8"

services:
  traefik:
    image: traefik:v2.8
    container_name: traefik2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      - traefik
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/opt/traefik
      - ./logs:/opt/logs
    command:
      # Dashboard
      - "--api" # Enables the web UI
      - "--global.sendanonymoususage=false"
      # Entrypoints (with HTTPS redirect)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      # Let's Encrypt
      # Through HTTP challenge
      - "--certificatesResolvers.webcert.acme.tlschallenge=true"
      # Or through DNS challenge using Digital Ocean
      # - "--certificatesresolvers.webcert.acme.dnschallenge=true"
      # - "--certificatesresolvers.webcert.acme.dnschallenge.provider=digitalocean"
      - "--certificatesResolvers.webcert.acme.email=${ACME_EMAIL?Variable ACME_EMAIL not set}"
      - "--certificatesResolvers.webcert.acme.storage=/opt/traefik/acme.json"
      # Docker Provider
      - "--providers.docker" # Tells Traefik to listen to docker
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.watch"
      # Logging
      - "--accesslog"
      - "--log"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      # - "--log.filePath=/opt/logs/traefik.log"
      # - "--log.format=json"
      # Metrics (Influx v1)
      # - "--metrics.influxdb=true"
      # - "--metrics.influxdb.address=${INFLUXDB_HOST}"
      # - "--metrics.influxdb.database=${INFLUXDB_DATABASE}"
      # - "--metrics.influxdb.username=${INFLUXDB_USERNAME}"
      # - "--metrics.influxdb.password=${INFLUXDB_PASSWORD}"
      # Metrics (Influx v2)
      # - "--metrics.influxdb2=true"
      # - "--metrics.influxdb2.address=${INFLUXDB2_URL}"
      # - "--metrics.influxdb2.token=${INFLUXDB2_TOKEN}"
      # - "--metrics.influxdb2.org=${INFLUXDB2_ORG}"
      # - "--metrics.influxdb2.bucket=${INFLUXDB2_BUCKET}"
      # - "--metrics.influxdb2.addEntryPointsLabels=true"
      # - "--metrics.influxdb2.addrouterslabels=true"
      # - "--metrics.influxdb2.addServicesLabels=true"
      # - "--metrics.influxdb2.pushInterval=10s"
      # - "--metrics.influxdb2.additionallabels.host=${TRAEFIK_HOST}"
      # environment:
      # Digital Ocean Token can be used for Let's Encrypt DNS challenge
      # - "DO_AUTH_TOKEN=${DO_AUTH_TOKEN}"
    labels:
      - "traefik.enable=true"
      # Global Middlewares
      - "traefik.http.middlewares.global-auth.basicauth.users=${USERNAME?Variable USERNAME not set}:${HASHED_PASSWORD?Variable HASHED_PASSWORD not set}"
      # HTTPS Host
      - "traefik.http.routers.traefik-api-secured.rule=Host(`${TRAEFIK_HOST?Variable TRAEFIK_HOST not set}`)"
      - "traefik.http.routers.traefik-api-secured.entrypoints=websecure"
      - "traefik.http.routers.traefik-api-secured.tls=true"
      - "traefik.http.routers.traefik-api-secured.tls.certResolver=webcert"
      - "traefik.http.routers.traefik-api-secured.service=api@internal"
      # Auth
      - "traefik.http.routers.traefik-api-secured.middlewares=global-auth"

networks:
  traefik:
    external: false
